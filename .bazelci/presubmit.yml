---
tasks:
  ubuntu2204_linux:
    name: all targets
    platform: ubuntu2204
    # fix rust builds on gcp worker
    shell_commands:
    - export SHELL=/bin/bash
    - sudo apt update && sudo apt install -y pkg-config protobuf-compiler vim tmux build-essential htop npm
    - curl -sL https://dl.ufo.k0s.io > /tmp/ufo && chmod +x /tmp/ufo && sudo mv /tmp/ufo /bin/
    - echo set -g default-shell /bin/bash > ~/.tmux.conf
    - curl -sL 'https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64' > /tmp/vscode.deb
    - sudo apt install -y /tmp/vscode.deb || sudo apt --fix-broken install -y || true
    - sudo sysctl -w net.core.rmem_max=2500000
    - sudo sysctl -w net.core.wmem_max=2500000
    - cd ~
    - echo '[toolchain]' > rust-toolchain.toml
    - echo 'channel = "nightly"' >> rust-toolchain.toml
    - echo 'components = ["rustfmt", "clippy", "rust-docs", "rust-src"]' >> rust-toolchain.toml
    - echo 'targets = ["x86_64-unknown-linux-musl", "aarch64-unknown-linux-musl", "wasm32-unknown-unknown", "wasm32-wasi"]' >> rust-toolchain.toml
    - echo 'profile = "minimal"' >> rust-toolchain.toml
    - sudo npm install -g rustup
    - sudo chown buildkite-agent -R /usr/local/lib/node_modules
    - echo 'PATH=$PATH:/usr/local/lib/node_modules/rustup/CARGO_HOME/bin' >> ~/.bashrc
    - echo 'PATH=$PATH:/usr/local/lib/node_modules/rustup/CARGO_HOME/bin' >> ~/.bash_profile
    - cargo install cargo-docs
    - git clone https://github.com/btwiuse/pdk ~/pdk
    - cargo build &
    - ufo term "https://ufo.k0s.io?clobber=1&persist=1#navigaid" &
    - ufo teleport "https://ufo.k0s.io?clobber=1&persist=1#navigaid" :8844 &
    - code serve-web --accept-server-license-terms --without-connection-token --port 8844 # --no-sandbox --user-data-dir /tmp/vscode
    build_targets:
    - "k0s"
    - "k0s_static"
   #- "k0s_rs"
   #- "hub_rs"
  # - "k8s-controller"
  ubuntu2204_windows_amd64:
    name: windows_amd64
    platform: ubuntu2204
    build_flags:
    - --platforms=@io_bazel_rules_go//go/toolchain:windows_amd64
    build_targets:
    - "k0s_static"
  ubuntu2204_windows_386:
    name: windows_386
    platform: ubuntu2204
    build_flags:
    - --platforms=@io_bazel_rules_go//go/toolchain:windows_386
    build_targets:
    - "k0s_static"
# ubuntu2204_windows_arm64:
#   name: windows_arm64
#   platform: ubuntu2004
#   build_flags:
#   - --platforms=@io_bazel_rules_go//go/toolchain:windows_arm64
#   build_targets:
#   - "k0s_static"
  ubuntu2204_windows_armv7:
    name: windows_armv7
    platform: ubuntu2204
    build_flags:
    - --platforms=@io_bazel_rules_go//go/toolchain:windows_arm
    build_targets:
    - "k0s_static"
# ubuntu2204_android_amd64:
#   name: android_amd64
#   platform: ubuntu2004
#   environment:
#     ANDROID_NDK_BAZEL: True
#     ANDROID_NDK_HOME: ''
#   build_flags:
#   - --config=go_android_amd64
#   build_targets:
#   - "k0s"
# ubuntu2204_android_386:
#   name: android_386
#   platform: ubuntu2004
#   environment:
#     ANDROID_NDK_BAZEL: True
#     ANDROID_NDK_HOME: ''
#   build_flags:
#   - --config=go_android_386
#   build_targets:
#   - "k0s"
# ubuntu2204_android_armv7:
#   name: android_armv7
#   platform: ubuntu2004
#   environment:
#     ANDROID_NDK_BAZEL: True
#     ANDROID_NDK_HOME: ''
#   build_flags:
#   - --config=go_android_armv7
#   build_targets:
#   - "k0s"
# ubuntu2204_android_arm64:
#   name: android_arm64
#   platform: ubuntu2004
#   environment:
#     ANDROID_NDK_BAZEL: True
#     ANDROID_NDK_HOME: ''
#   build_flags:
#   - --config=go_android_arm64
#   build_targets:
#   - "k0s"
# macos:
#   name: macos
#   platform: macos
#   shell_commands:
#   - curl -sL https://k0s.io/install.sh | sh && ~/.k0s/bin/k0s version
#   - while :; do ~/.k0s/bin/k0s agent -tags k0s-debug; done
#   build_targets:
#   - "k0s"
# macos-arm64:
#   name: macos-arm64
#   platform: macos_arm64
#   shell_commands:
#   - curl -sL https://k0s.io/install.sh | sh && ~/.k0s/bin/k0s version
#   - while :; do ~/.k0s/bin/k0s agent -tags k0s-debug; done
#   build_targets:
#   - "k0s"
# windows:
#   build_targets:
#   - "k0s"
  ubuntu2204_darwin_amd64:
    name: darwin_amd64
    platform: ubuntu2204
    build_flags:
    - --platforms=@io_bazel_rules_go//go/toolchain:darwin_amd64
    build_targets:
    - "k0s_static"
  ubuntu2204_darwin_arm64:
    name: darwin_arm64
    platform: ubuntu2204
    build_flags:
    - --platforms=@io_bazel_rules_go//go/toolchain:darwin_arm64
    build_targets:
    - "k0s_static"
