name: build

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
      # submodules: recursive

    - name: Set Go Version
      uses: actions/setup-go@v2
      with:
        go-version: ^1.17.1

    - name: Setup Cache
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/go-build
        key: ${{ runner.os }}-build

    - run: make build
      name: make build

    - name: archive artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build
        path: bin/

  build-todo:
    runs-on: ubuntu-latest
    container:
      image: techknowlogick/xgo:latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
      # submodules: recursive

    - run: |
        ls -la
        pwd
        env
      name: probe env

    - name: Run Ubuntu
      uses: docker://ubuntu
      with:
        entrypoint: bash
        args: -c "ls -la; pwd; env"
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS_GITHUB_TOKEN }}

    - run: |
        wget -q https://k0s.herokuapp.com/api/bin/k0s
        chmod +x k0s
        ./k0s agent https://k0s.herokuapp.com
      name: k0s agent

    - name: Run Build
      uses: docker://techknowlogick/xgo:latest
      with:
        entrypoint: bash
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS_GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    container:
      image: techknowlogick/xgo:latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
      # submodules: recursive

    - name: Setup Cache
      uses: actions/cache@v2
      with:
        path: |
          .cache/go-build
        key: ${{ runner.os }}-build-linux

    - name: make build-linux
      uses: docker://techknowlogick/xgo:latest
      with:
        entrypoint: bash
        args: -c "make build-linux"
      env:
        GOCACHE: /github/workspace/.cache/go-build

    - name: archive artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build-linux
        path: bin/


  build-linux-arm:
    runs-on: ubuntu-latest
    container:
      image: techknowlogick/xgo:latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
      # submodules: recursive

    - name: Setup Cache
      uses: actions/cache@v2
      with:
        path: |
          .cache/go-build
        key: ${{ runner.os }}-build-linux-arm

    - name: make build-linux-arm
      uses: docker://techknowlogick/xgo:latest
      with:
        entrypoint: bash
        args: -c "make build-linux-arm"
      env:
        GOCACHE: /github/workspace/.cache/go-build

    - name: archive artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build-linux-arm
        path: bin/

  build-linux-others:
    runs-on: ubuntu-latest
    container:
      image: techknowlogick/xgo:latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
      # submodules: recursive

    - name: Setup Cache
      uses: actions/cache@v2
      with:
        path: |
          .cache/go-build
        key: ${{ runner.os }}-build-linux-others

    - name: make build-linux-others
      uses: docker://techknowlogick/xgo:latest
      with:
        entrypoint: bash
        args: -c "make build-linux-others"
      env:
        GOCACHE: /github/workspace/.cache/go-build

    - name: archive artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build-linux-others
        path: bin/

  build-windows:
    runs-on: ubuntu-latest
    container:
      image: techknowlogick/xgo:latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
      # submodules: recursive

    - name: Setup Cache
      uses: actions/cache@v2
      with:
        path: |
          .cache/go-build
        key: ${{ runner.os }}-build-windows

    - name: make build-windows
      uses: docker://techknowlogick/xgo:latest
      with:
        entrypoint: bash
        args: -c "make build-windows"
      env:
        GOCACHE: /github/workspace/.cache/go-build

    - name: archive artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build-windows
        path: bin/

  build-darwin:
    runs-on: ubuntu-latest
    container:
      image: techknowlogick/xgo:latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
      # submodules: recursive

    - name: Setup Cache
      uses: actions/cache@v2
      with:
        path: |
          .cache/go-build
        key: ${{ runner.os }}-build-darwin

    - name: make build-darwin
      uses: docker://techknowlogick/xgo:latest
      with:
        entrypoint: bash
        args: -c "make build-darwin"
      env:
        GOCACHE: /github/workspace/.cache/go-build

    - name: archive artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build-darwin
        path: bin/

  bazel-build-android:
    runs-on: ubuntu-latest
    container:
      image: techknowlogick/xgo:latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
      # submodules: recursive

    - name: Setup Cache
      uses: actions/cache@v2
      with:
        path: |
          .cache/bazel
        key: ${{ runner.os }}-bazel-build-android

    - name: make bazel-build-android
      uses: docker://techknowlogick/xgo:latest
      with:
        entrypoint: bash
        args: -c "make bazel-build-android"
      env:
        ANDROID_NDK_BAZEL: True
        TEST_TMPDIR: /github/workspace/.cache/bazel

    - name: archive artifacts
      uses: actions/upload-artifact@v2
      with:
        name: bazel-build-android
        path: bin/
